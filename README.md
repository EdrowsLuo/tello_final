# tello_final
## 最终方案
### 无人机移动控制方案  
关键的移动控制只有两个，都是对sdk里的go和rotate指令的封装，位于utils.drone_utils内  
- goto：移动到指定的位置（坐标基于定位毯），
  如果移动后偏移过大则继续自动调整位置。（~~过于直白的控制方法~~）
- look_at：旋转无人机使视角看向某个点
  
在开发过程中了解到sdk中的rc指令可以做到更加直接的控制无人机，但是控制逻辑上
需要下更多的功夫，有一组采用了这种方法，但是我们组并没有想到非常好的直接控制的方案。
这里提一下来告诉你们还有另外的控制无人机的方法。
  
### 着火点识别方案
使用传统图像识别方案，通过HSV值过滤画面中的红色部分，
通过腐蚀等方法消除一些干扰，再找出面积最大的轮廓。  
我们实际操作的时候还过滤了面积过小和轮廓不够圆的情况，这些并不是必要的。

### 物品识别方案
最开始使用[yolo_v3](https://github.com/ultralytics/yolov3)，
但是因为数据集太小，而且采数据集的时候角度、距离、光照区别都不是非常大，
在实际使用中识别效果不是非常好，部分对象想要准确识别的话需要无人机非常精确的定位和移动，
这个在实际操作中是十分困难的（tello edu版的无人机性能和sdk功能限制）。  

于是我们组使用了较新的[efficientdet](https://github.com/toandaominh1997/EfficientDet.Pytorch)，
在使用最后新扩充的数据集进行训练后，达到了非常高的性能，基本解决了上面所说到的问题，
最后在goto功能允许较大的位置误差的情况下，也准确的完成了识别任务。

### 上位机通信方案
因为我们主要的功能都运行、调试在Python 3.7中，而和上位机通信使用的ros需要Python 2.7,
于是我们通过在可以使用ros的Python 2.7环境中使用一个http服务来转发ros相关的需求，
其余的代码任然保证在和测试环境一样的环境内跑。

### 代码编写方案
~~一堆花里胡哨的东西~~  
事实上我们最后的代码量并不多，最耗时间的部分依然是debug（其实大部分组都是类似的）  
我们为了降低debug的复杂度，模仿分布式服务的架构把各种功能都写成了单独的服务，
于是我们就可以单独的测试特定功能的效果。
而且通过这种设计我们得以方便的开发除了比赛流程以外的其他功能: 
#### tello_panda
一个在3D场景里显示无人机位置、姿态等的服务。   
#### tello_save_video
一个无人机拍摄视频并保存的服务。  
#### tello_yolo
里也非常简单的就实现了一个实时检测视野内物品的服务。  
#### tello_imshow
非常快速优美的修复了在Linux上跨线程使用cv2.imshow导致的卡死，
在不修改原本代码的情况下修复了这个bug。  
......

事实上ros系统也是一种分布式系统，确实也是一种非常灵活的系统。
但是ros作为分布式系统设计的并不完全，正是因为这个原因我们选择了放弃ros。  
主要的原因就在于ros对通信形式的高度限制，
大部分情况下的通信都是只有输入（Subscriber）或者只有输出（Publisher）。   
当然ros其实也有解决这个问题的附加功能，但是依然无法达到通用的分布式系统的那种灵活性。  
于是我们选择模仿这种架构来自己实现了一些关键功能。
  
## 大致目录结构
* image_detect
  * [yolo_v3](https://github.com/ultralytics/yolov3)，权重文件过大，并没有上传到repo里

* mydetect
  * [efficientdet](https://github.com/toandaominh1997/EfficientDet.Pytorch)，
  已经将训练好的权重随repo发布了，可以直接使用

* control  
  这个模块里包含了主要的功能，模仿分布式服务来写灵活的代码！
  * tello_center
    * 模仿分布式服务的一个服务中心，
    通过这种模式来方便配置的处理以及模仿的简单的服务注册功能，
    来实现一种灵活的代码结构
    * 通过代理模式来方便服务的发现和调用
  * tello_abs
    * 内含修改自Tello官方SDK的无人机控制类，
    以及处理无人机初始化的一个服务。
    * ~~一个响应式的处理图像和state变换的服务~~（并没有起到特别大的作用）
  * tello_image_process
    * 设计之初用于托管处理所有的图像识别的服务，
    最后实际只是用来显示无人机视角和状态（只需要注册了服务就会开启这个功能）
    * ~~检测着火点~~（为了节省写代码的时间检测过程都被直接写进了控制代码里）
  * tello_imshow
    * 注册这个服务后就会把cv2的imshow功能做一个替换（实际上是替换了locks.imshow),
    在一个单独的线程里执行显示图像的功能，防止在Linux上多线程使用imshow导致的锁死。
  * tello_judge_client
    * 用于处理和上位机上报比赛流程的服务，
    包含了client以及一个对和上位机交互的抽象服务，通过改变注册的这个抽象服务类别
    来做到本地运行测试和在上位机上运行测试的特定环境部署特定功能。
    * ~~我一开始也没想到可以用这种方法来做到差异部署~~
  * ~~tello_panda（弃用）~~
    * 本来是一个显示当前无人机位置和视角碰撞的模块，
    但是定位毯实在太不靠谱了 :(
    * 虽然很帅但是没啥实际作用（花里胡哨）
  * ~~tello_world（弃用）~~
    * 存储世界模型以及处理射线检测和碰撞的模块，弃用理由同上。
  * tello_save_video
    * 保存无人机摄像头视频的服务（用于debug）
    * 注册即可使用，退出时自动保存
  * tello_yolo
    * 提供图像识别的功能，并对原yolo检测和新的efficientdet统一接口。
    * ~~改一个设置就可以随便选识别算法，它不香吗~~
    * ~~为了处理pytorch只能在主线程跑的问题加了个把检测转发到主线程的功能~~（过于丢人的修bug）
  * tello_main
    * 测试时使用的主入口，算是一个修改配置和服务注册的例子  
  * tello_control
    * 控制整个比赛流程的服务（~~实际上为了方便把大部分流程写进一个函数了~~）
    * 控制无人机移动的功能其实就写了两个简单的函数
    （utils.drone_util里的goto和look_at)
  * 几乎所有模块都有单元测试，方便debug
  
  
